<NODE export_version="0.5" nodetype="htmlcode" title="uploadimage">
  <field name="author_user" type="noderef" type_nodetype="user,nodetype">root</field>
  <field name="authoraccess" type="literal_value">iiii</field>
  <field name="code" type="literal_value"># [{uploadimage:field}]
#
# generates an input file field, and sets the field to the URL 

my ($field) =@_;

my $S = getNode('uploadimage settings', 'setting');
$S or return "can't find uploadimage settings!";

my $V = $S->getVars;

my $str ="";
my $name = $field."_file";

my $imagedir = $$V{uploadimagedir};
return "You need to specify the incoming image directory as 'uploadimagedir' in ".linkNode($S).".  Make sure
it is a directory under your Apache's root directory, and writeable by the
nobody user." if not $imagedir or $imagedir =~ /^\#/;

$imagedir .= "/" unless $imagedir =~ /\/$/;


#you probably need to change this field
my $imageurl = $$V{uploadimageURL};
return "You need to specify the incoming image directory's URL as 'uploadimageURL' in ".linkNode($S).".  Make sure
it is the path to $imagedir through Apache." if not $imagedir or $imagedir =~ /^\#/;

$imageurl .= "/" unless $imageurl =~ /\/$/;


if ($query->param($name)) {
  my ($fname) = $query->param($name);
  my $imgname = $fname;
  $imgname =~ s/\s/\_/gs;
  $imgname =~  s/.*[\/|\\]([\w|\.|\-]*)$/$1/;
  my $outfile = $imagedir.$imgname;

  
  $str.= "'". $query->uploadInfo($fname)->{"Content-Type"}."'!";
	
  $str.= "&lt;br>warning, this image clobbered an image by the same name!" if -e $outfile;
  open OUTFILE, ">$outfile";
  my ($buf, $size);
  while (my $bytes = read($fname, $buf, 1024)) { 
    $size+=$bytes;
    print OUTFILE $buf;
  }
  close OUTFILE;

  $$NODE{$field} = $imageurl.$imgname;
  $NODE->update($USER);
  # $str.="$size bytes recieved!";
} else {
  $str.=$query->filefield($name);
}
$str;</field>
  <field name="dynamicauthor_permission" type="literal_value">-1</field>
  <field name="dynamicgroup_permission" type="literal_value">-1</field>
  <field name="dynamicguest_permission" type="literal_value">-1</field>
  <field name="dynamicother_permission" type="literal_value">-1</field>
  <field name="group_usergroup" type="literal_value">-1</field>
  <field name="groupaccess" type="literal_value">iiii-</field>
  <field name="guestaccess" type="literal_value">iiii-</field>
  <field name="loc_location" type="noderef" type_nodetype="location,nodetype">htmlcode</field>
  <field name="otheraccess" type="literal_value">iiii-</field>
  <field name="title" type="literal_value">uploadimage</field>
  <field name="type_nodetype" type="noderef" type_nodetype="nodetype,nodetype">htmlcode</field>
</NODE>
