<NODE><INFO>rendered by Everything::XML.pm</INFO>
	<author_user table="node" type="usergroup">gods</author_user>
	<core table="node">R</core>
	<doctext table="document">[%
my $str;

local *generateLogin = sub {
 $query-&gt;start_form
    .'&lt;INPUT TYPE="hidden" NAME="op" VALUE="newuser"&gt;'
    .$query-&gt;hidden('node_id', getId($NODE))
    .'Preferred User Name:
      &lt;INPUT TYPE="text" NAME="nu_name" VALUE=""&gt;&lt;br&gt;
      Real&amp;#153; Name:'
    .$query-&gt;textfield("nu_realname", "", 30)
    .'&lt;br&gt;Email Address:'
    .$query-&gt;textfield("nu_email", "", 20)
    .'&lt;br&gt;'
    .$query-&gt;submit("sexisgood", "submit")
    .$query-&gt;end_form;
 };



if ($$USER{title} ne "Guest User") {
 # return "You already &lt;i&gt;are&lt;/i&gt; a user -- you don't need an alter-ego...";
}



unless ($query-&gt;param("op") eq "newuser") {
  $str.="
To create a new user on Everything, we need a smattering of information:
&lt;p&gt;";  


$str .=generateLogin();

 $str .= '
&lt;p&gt;
&lt;i&gt;&lt;b&gt;Please note:&lt;/b&gt;
We are not going to send you junk email "member updates", sell your
address to spammers, or display your email address for people to see.  
This email exists so that you can recieve your password, and/or retrieve
it if you forget.  There may be future email functionality, which
you will have the option to turn on from your user settings page.  
&lt;/i&gt;';
return $str;

} 

my $realname = $query-&gt;param("nu_realname");
my $email = $query-&gt;param("nu_email");
my $name = $query-&gt;param("nu_name");

#check if the user exists
if (my ($olduser) = $DB-&gt;getNodeWhere ({title =&gt; $name},
	$DB-&gt;getType('user'))) {
  return "Sorry, ".linkNode($olduser)
    ." already exists.  Pick a variation, or try another name...&lt;p&gt;\n".generateLogin();  
}

#generate the passwd and send it out on email.
my @chars = ( "A" .. "Z", "a" .. "z", 0 .. 9);
my $passwd = join("", @chars[ map { rand @chars } ( 1 .. 8 ) ]);
 

my $NEWUSER = $DB-&gt;insertNode ($name, $DB-&gt;getType('user'), -1,
  {realname =&gt; $realname,
  email =&gt; $email,
  passwd =&gt; $passwd});
getRef $NEWUSER;
$$NEWUSER{author_user} = getId ($NEWUSER);
$DB-&gt;updateNode($NEWUSER,-1);


$str.="Your new user account ("
  .linkNode($NEWUSER)
  .") has been created.  You ($email) should be getting an email soon telling you your generated password.";

#send some email;
my ($n) = $DB-&gt;getNodeWhere({title=&gt;'New User Mail'}, $DB-&gt;getType('mail'));
$$n{doctext} =~ s/\&lt;user\&gt;/$$NEWUSER{realname}/;
$$n{doctext} =~ s/\&lt;name\&gt;/$$NEWUSER{title}/;
$$n{doctext} =~ s/\&lt;passwd\&gt;/$$NEWUSER{passwd}/;
$$n{doctext} =~ s/\&lt;url\&gt;/$HTMLVARS{site_url}index\.pl\?node=$$NEWUSER{title}\&amp;type=user/;
use Everything::MAIL;
node2mail($$NEWUSER{email},$n);

$str;


%]





</doctext>
	<package table="node">0</package>
	<reputation table="node">0</reputation>
	<title table="node">Create A New User</title>
	<type_nodetype table="node" type="nodetype">superdoc</type_nodetype>
</NODE>
