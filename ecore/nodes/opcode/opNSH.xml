<NODE export_version="0.5" nodetype="opcode" title="opNSH">
  <field type="noderef" type_nodetype="user,nodetype" name="author_user">root</field>
  <field type="literal_value" name="authoraccess">iiii</field>
  <field type="literal_value" name="code">my $nsh = $query->param("nsh");

return unless($nsh &amp;&amp; $nsh ne "");

my $nodes;
my $NODE = getNode($query->param("node_id"));
my $cmdline = parseNSH($nsh);

return "" unless($cmdline &amp;&amp; @$cmdline > 0);

my $cmd = shift @$cmdline;

if($cmd =~ /^cd$/i)
{
  my $startLoc;
  my $dest = shift @$cmdline;

  if($dest =~ /^\//)
  {
    # This is an absolute path. Start at the root.
    $startLoc = 0;
    $dest =~ s/^\///;
  }
  elsif($NODE->isOfType("location"))
  {
    $startLoc = $$NODE{node_id};
  }
  else
  {
    $startLoc = $$NODE{loc_location};
  }

  $startLoc = getNode($startLoc);

  my @locs = split '/', $dest;
  my $location = getType("location");
  
  foreach my $loc (@locs)
  {
    if($loc eq "..")
    {
      $startLoc = $startLoc->getParentLocation();
    }
    else
    { 
      $startLoc = getNode({ title => $loc, loc_location => $$startLoc{node_id} },
        $location);
    }

    unless($startLoc)
    {
      $GLOBAL{nsh_errors} = "Unknown path: $dest";
      return;
    }
  }

  # We found what they specified!  Go there!
  $query->param("node_id", $$startLoc{node_id}); 
}
elsif($cmd =~ /^rm$/i)
{
  $GLOBAL{nsh_errors} = "Command 'rm' not implemented"; 
  return;
}
elsif($cmd =~ /^mv$/i)
{
  $GLOBAL{nsh_errors} = "Command 'mv' not implemented"; 
  return;

  my @nodes;

  # The last one is where to move them to...
  while(@$cmdline > 1)
  {
    push @nodes, @{ getNodesFromPath(shift @$cmdline) };
  }
}
else
{
  $GLOBAL{nsh_errors} = "Unknown command: $cmd";
}


# Parses our "command line"
sub parseNSH
{
  my ($cmdline) = @_;
  my @files;
  my $count = 0;  # just to prevent any possible infinite loops...
  
  $cmdline =~ s/^([^ ]+) //;

  push @files, $1;  # the command

  # Convert 2 or more spaces into one space
  $cmdline =~ s/ +/ /g;

  while($cmdline ne "" &amp;&amp; $count &lt; 30)
  {
    if($cmdline =~ /^["']/)
    {
      $cmdline =~ s/^(["'])([^"']*)["']//;
      push @files, $2;
    }
    else
    {
      $cmdline =~ s/^([^ ]*)//;
      push @files, $1;
    }

    $cmdline =~ s/^ //;
    $count++;
  }

  return \@files;
}</field>
  <field type="literal_value" name="dynamicauthor_permission">-1</field>
  <field type="literal_value" name="dynamicgroup_permission">-1</field>
  <field type="literal_value" name="dynamicguest_permission">-1</field>
  <field type="literal_value" name="dynamicother_permission">-1</field>
  <field type="literal_value" name="group_usergroup">-1</field>
  <field type="literal_value" name="groupaccess">iiii-</field>
  <field type="literal_value" name="guestaccess">-----</field>
  <field type="noderef" type_nodetype="location,nodetype" name="loc_location">opcode</field>
  <field type="literal_value" name="otheraccess">-----</field>
  <field type="literal_value" name="title">opNSH</field>
  <field type="noderef" type_nodetype="nodetype,nodetype" name="type_nodetype">opcode</field>
</NODE>
